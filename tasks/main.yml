---
# Copyright (c) 2021 Jakob Meng, <jakobmeng@web.de>
# vim:set fileformat=unix tabstop=2 shiftwidth=2 expandtab:
# kate: end-of-line unix; space-indent on; indent-width 2; remove-trailing-spaces modified;

- name: Load variables to identify OS
  import_role:
    name: jm1.common # If Ansible raises "ERROR! the role 'jm1.common' was not found" then you might use the
                     # ansible-galaxy and the provided requirements.yml to install all missing role dependencies.

- name: Install dependencies of collection jm1.pkg
  import_role:
    name: jm1.pkg.setup # If Ansible raises "ERROR! the role 'jm1.pkg.setup' was not found" then you might use the
                        # ansible-galaxy and the provided requirements.yml to install all missing role dependencies.

- name: Satisfy requirements on CentOS and Red Hat Enterprise Linux
  when: distribution_id|first in ['CentOS', 'Red Hat Enterprise Linux']
  jm1.pkg.meta_pkg:
    name: "jm1-httpd"
    version: "1"
    depends:
    - httpd

- name: Satisfy requirements on Debian and Ubuntu
  when: distribution_id|first in ['Debian', 'Ubuntu']
  jm1.pkg.meta_pkg:
    name: "jm1-httpd"
    version: "1"
    depends:
    - apache2

- name: Enable/disable httpd modules
  loop: '{{ httpd_config|default([]) }}'
  when: "'apache2_module' in item"
  apache2_module: "{{ item['apache2_module'] }}"
  register: httpd_config_apache2_module_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Change blocks in httpd configuration
  loop: '{{ httpd_config|default([]) }}'
  when: "'blockinfile' in item"
  blockinfile: "{{ item['blockinfile'] }}"
  register: httpd_config_blockinfile_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Copy files to httpd configuration
  loop: '{{ httpd_config|default([]) }}'
  when: "'copy' in item"
  copy: "{{ item['copy'] }}"
  register: httpd_config_copy_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Change debconf selections for httpd
  loop: '{{ httpd_config|default([]) }}'
  when: "'debconf' in item"
  debconf: "{{ item['debconf'] }}"
  register: httpd_config_debconf_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Manage files in httpd configuration
  loop: '{{ httpd_config|default([]) }}'
  when: "'file' in item"
  file: "{{ item['file'] }}"
  register: httpd_config_file_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Change lines in httpd configuration
  loop: '{{ httpd_config|default([]) }}'
  when: "'lineinfile' in item"
  lineinfile: "{{ item['lineinfile'] }}"
  register: httpd_config_lineinfile_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Generate httpd configuration from templates
  loop: '{{ httpd_config|default([]) }}'
  when: "'template' in item"
  template: "{{ item['template'] }}"
  register: httpd_config_template_result
  notify:
  - 'Restart httpd service to apply changes'

- name: Manage httpd service
  service:
    enabled: '{{ httpd_service_enabled }}'
    name: '{{ httpd_service_name }}'
    state: '{{ httpd_service_state }}'

- name: Debug role variables
  debug:
    msg:
      httpd_config_apache2_module_result: '{{ httpd_config_apache2_module_result }}'
      httpd_config_blockinfile_result: '{{ httpd_config_blockinfile_result }}'
      httpd_config_copy_result: '{{ httpd_config_copy_result }}'
      httpd_config_debconf_result: '{{ httpd_config_debconf_result }}'
      httpd_config_file_result: '{{ httpd_config_file_result }}'
      httpd_config_lineinfile_result: '{{ httpd_config_lineinfile_result }}'
      httpd_config_template_result: '{{ httpd_config_template_result }}'
  tags:
    - never
    - debug
