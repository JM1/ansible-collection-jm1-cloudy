---
# Copyright (c) 2020-2021 Jakob Meng, <jakobmeng@web.de>
# vim:set fileformat=unix tabstop=2 shiftwidth=2 expandtab:
# kate: end-of-line unix; space-indent on; indent-width 2; remove-trailing-spaces modified;

- name: Add/Remove OpenStack security groups
  loop: '{{ openstack_security_groups | default([]) }}'
  openstack.cloud.security_group: "{{ item
    | dict2items | rejectattr('key', 'eq', 'rules') | list | items2dict
    | combine({} if 'auth' in item else {'auth': openstack_auth})
    | combine({} if 'cloud' in item else {'cloud': openstack_cloud})
    | combine({} if 'interface' in item else {'interface': openstack_interface})
  }}"

- name: Add/Remove rules from a OpenStack security group
  loop: "{{ openstack_security_groups | default([]) | subelements('rules') }}"
  when: item.0.state == 'present'
  openstack.cloud.security_group_rule: "{{ item.1
    | combine({'auth': item.0.auth if 'auth' in item.0 else openstack_auth})
    | combine({'cloud': item.0.cloud if 'cloud' in item.0 else openstack_cloud})
    | combine({'interface': item.0.interface if 'interface' in item.0 else openstack_interface})
    | combine({'project': item.0.project} if 'project' in item.0 else {})
    | combine({'security_group': item.0.name})
  }}"
